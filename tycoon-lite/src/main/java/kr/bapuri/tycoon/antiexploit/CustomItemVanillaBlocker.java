package kr.bapuri.tycoon.antiexploit;

import kr.bapuri.tycoon.item.CoreItemAuthenticator;
import org.bukkit.Material;
import org.bukkit.block.Block;
import org.bukkit.configuration.file.FileConfiguration;
import org.bukkit.entity.HumanEntity;
import org.bukkit.entity.Player;
import org.bukkit.event.EventHandler;
import org.bukkit.event.EventPriority;
import org.bukkit.event.Listener;
import org.bukkit.event.block.Action;
import org.bukkit.event.block.BlockDispenseEvent;
import org.bukkit.event.entity.EntityDamageByEntityEvent;
import org.bukkit.event.inventory.FurnaceBurnEvent;
import org.bukkit.event.inventory.FurnaceStartSmeltEvent;
import org.bukkit.event.inventory.PrepareAnvilEvent;
import org.bukkit.event.inventory.PrepareItemCraftEvent;
import org.bukkit.event.player.PlayerInteractEvent;
import org.bukkit.inventory.AnvilInventory;
import org.bukkit.inventory.CraftingInventory;
import org.bukkit.inventory.ItemStack;
import org.bukkit.inventory.meta.ItemMeta;
import org.bukkit.plugin.Plugin;

import java.util.logging.Logger;

/**
 * CustomItemVanillaBlocker - 커스텀 아이템의 바닐라 동작 차단
 * 
 * 차단 대상:
 * 1. 조합 재료 사용 (PrepareItemCraftEvent)
 * 2. 모루 재료 사용 (PrepareAnvilEvent)
 * 3. 화로/훈연기 연료 사용 (FurnaceBurnEvent)
 * 4. 퇴비통 투입 (PlayerInteractEvent + COMPOSTER)
 * 5. 디스펜서 발사 (BlockDispenseEvent)
 * 6. 방패 사용 (PlayerInteractEvent + EntityDamageByEntityEvent)
 * 
 * 정책: 100% 차단 (화이트리스트 없음)
 * 
 * 판별 로직:
 * 1. CoreItemAuthenticator.isCoreItem() - PDC 기반 (정확)
 * 2. CustomModelData 폴백 - v1.1 전까지 (범용)
 */
public class CustomItemVanillaBlocker implements Listener {

    private final Plugin plugin;
    private final Logger logger;
    private final CoreItemAuthenticator coreItemAuthenticator;
    
    // 설정 (antiexploit.yml에서 로드)
    private boolean enabled = true;
    private boolean logBlocked = true;
    
    // 개별 이벤트 ON/OFF
    private boolean blockCraft = true;
    private boolean blockAnvil = true;
    private boolean blockFurnace = true;
    private boolean blockComposter = true;
    private boolean blockDispenser = true;
    private boolean blockShield = true;

    public CustomItemVanillaBlocker(Plugin plugin, CoreItemAuthenticator coreItemAuthenticator) {
        this.plugin = plugin;
        this.logger = plugin.getLogger();
        this.coreItemAuthenticator = coreItemAuthenticator;
    }
    
    /**
     * 설정 로드 (antiexploit.yml)
     */
    public void loadConfig(FileConfiguration config) {
        enabled = config.getBoolean("customItemBlocker.enabled", true);
        logBlocked = config.getBoolean("customItemBlocker.logBlocked", true);
        
        blockCraft = config.getBoolean("customItemBlocker.events.craft", true);
        blockAnvil = config.getBoolean("customItemBlocker.events.anvil", true);
        blockFurnace = config.getBoolean("customItemBlocker.events.furnace", true);
        blockComposter = config.getBoolean("customItemBlocker.events.composter", true);
        blockDispenser = config.getBoolean("customItemBlocker.events.dispenser", true);
        blockShield = config.getBoolean("customItemBlocker.events.shield", true);
        
        if (enabled) {
            logger.info("[CustomItemVanillaBlocker] 초기화 완료 (craft=" + blockCraft + 
                       ", anvil=" + blockAnvil + ", furnace=" + blockFurnace + 
                       ", composter=" + blockComposter + ", dispenser=" + blockDispenser + 
                       ", shield=" + blockShield + ")");
        } else {
            logger.info("[CustomItemVanillaBlocker] 비활성화됨");
        }
    }

    // ========== 이벤트 핸들러 ==========

    /**
     * 조합 시 커스텀 아이템 사용 차단
     */
    @EventHandler(priority = EventPriority.HIGHEST)
    public void onPrepareItemCraft(PrepareItemCraftEvent event) {
        if (!enabled || !blockCraft) return;
        
        CraftingInventory inv = event.getInventory();
        
        for (ItemStack item : inv.getMatrix()) {
            if (isBlockedItem(item)) {
                inv.setResult(null);
                // 조합 중인 플레이어 식별
                Player player = null;
                if (!event.getViewers().isEmpty()) {
                    HumanEntity viewer = event.getViewers().get(0);
                    if (viewer instanceof Player p) {
                        player = p;
                    }
                }
                logBlocked("CRAFT", item, player);
                return;
            }
        }
    }
    
    /**
     * 모루에서 커스텀 아이템 사용 차단
     */
    @EventHandler(priority = EventPriority.HIGHEST)
    public void onPrepareAnvil(PrepareAnvilEvent event) {
        if (!enabled || !blockAnvil) return;
        
        AnvilInventory inv = event.getInventory();
        
        // 플레이어 식별
        Player player = null;
        if (!event.getViewers().isEmpty()) {
            HumanEntity viewer = event.getViewers().get(0);
            if (viewer instanceof Player p) {
                player = p;
            }
        }
        
        // 첫 번째 슬롯 (왼쪽)
        ItemStack firstItem = inv.getItem(0);
        if (isBlockedItem(firstItem)) {
            event.setResult(null);
            logBlocked("ANVIL", firstItem, player);
            return;
        }
        
        // 두 번째 슬롯 (오른쪽)
        ItemStack secondItem = inv.getItem(1);
        if (isBlockedItem(secondItem)) {
            event.setResult(null);
            logBlocked("ANVIL", secondItem, player);
        }
    }
    
    /**
     * 화로/훈연기에서 커스텀 아이템 연료 사용 차단
     */
    @EventHandler(priority = EventPriority.HIGHEST)
    public void onFurnaceBurn(FurnaceBurnEvent event) {
        if (!enabled || !blockFurnace) return;
        
        ItemStack fuel = event.getFuel();
        if (isBlockedItem(fuel)) {
            event.setCancelled(true);
            event.setBurnTime(0);
            logBlocked("FURNACE_FUEL", fuel, null);
        }
    }
    
    /**
     * 화로/훈연기에서 커스텀 아이템 재료 굽기 차단 (Paper API)
     */
    @EventHandler(priority = EventPriority.HIGHEST)
    public void onFurnaceStartSmelt(FurnaceStartSmeltEvent event) {
        if (!enabled || !blockFurnace) return;
        
        ItemStack source = event.getSource();
        if (isBlockedItem(source)) {
            // 굽기 시간을 매우 길게 설정하여 실질적으로 차단
            // (이 이벤트는 취소 불가능하므로 우회 방법 사용)
            event.setTotalCookTime(Integer.MAX_VALUE);
            logBlocked("FURNACE_SMELT", source, null);
        }
    }
    
    /**
     * 퇴비통에 커스텀 아이템 투입 차단
     */
    @EventHandler(priority = EventPriority.HIGHEST)
    public void onPlayerInteractComposter(PlayerInteractEvent event) {
        if (!enabled || !blockComposter) return;
        if (event.getAction() != Action.RIGHT_CLICK_BLOCK) return;
        
        Block block = event.getClickedBlock();
        if (block == null || block.getType() != Material.COMPOSTER) return;
        
        ItemStack item = event.getItem();
        if (isBlockedItem(item)) {
            event.setCancelled(true);
            logBlocked("COMPOSTER", item, event.getPlayer());
        }
    }
    
    /**
     * 디스펜서에서 커스텀 아이템 발사 차단
     */
    @EventHandler(priority = EventPriority.HIGHEST)
    public void onBlockDispense(BlockDispenseEvent event) {
        if (!enabled || !blockDispenser) return;
        
        ItemStack item = event.getItem();
        if (isBlockedItem(item)) {
            event.setCancelled(true);
            logBlocked("DISPENSER", item, null);
        }
    }
    
    /**
     * 커스텀 방패 블로킹 효과 무효화
     * 
     * 정책: 장착은 허용, 블로킹 효과만 무효화
     * - 커스텀 방패로 블로킹 중일 때 데미지를 원본으로 복원
     * - 모든 장착 경로를 막을 필요 없이 확실하게 차단
     */
    @EventHandler(priority = EventPriority.HIGHEST, ignoreCancelled = true)
    public void onEntityDamageShieldBlock(EntityDamageByEntityEvent event) {
        if (!enabled || !blockShield) return;
        if (!(event.getEntity() instanceof Player victim)) return;
        
        // 블로킹 상태가 아니면 무시
        if (!victim.isBlocking()) return;
        
        // 방어에 사용된 방패 확인 (오프핸드 우선)
        ItemStack blockingItem = victim.getInventory().getItemInOffHand();
        if (blockingItem.getType() != Material.SHIELD) {
            blockingItem = victim.getInventory().getItemInMainHand();
        }
        
        if (blockingItem.getType() != Material.SHIELD) return;
        
        // 커스텀 방패면 블로킹 효과 무효화
        if (isBlockedItem(blockingItem)) {
            // 원본 데미지 복원 (블로킹으로 감소된 데미지를 원래대로)
            // EntityDamageByEntityEvent에서 getDamage()는 이미 블로킹 적용 후 값
            // 블로킹은 일반적으로 데미지를 0으로 만들거나 크게 감소시킴
            // 완벽한 복원은 어렵지만, 최소 데미지를 보장
            double originalDamage = event.getDamage(EntityDamageByEntityEvent.DamageModifier.BASE);
            event.setDamage(originalDamage);
            
            victim.sendMessage("§c커스텀 아이템은 방패로 사용할 수 없습니다.");
            logBlocked("SHIELD_BLOCK", blockingItem, victim);
        }
    }
    
    /**
     * 커스텀 방패 우클릭 시 경고 (선택적)
     */
    @EventHandler(priority = EventPriority.HIGHEST)
    public void onPlayerInteractShield(PlayerInteractEvent event) {
        if (!enabled || !blockShield) return;
        if (event.getAction() != Action.RIGHT_CLICK_AIR && 
            event.getAction() != Action.RIGHT_CLICK_BLOCK) {
            return;
        }
        
        Player player = event.getPlayer();
        
        // 메인핸드 커스텀 방패 우클릭 시 경고 및 차단
        ItemStack mainHand = player.getInventory().getItemInMainHand();
        if (mainHand.getType() == Material.SHIELD && isBlockedItem(mainHand)) {
            event.setCancelled(true);
            player.sendMessage("§c커스텀 방패는 사용할 수 없습니다.");
            logBlocked("SHIELD_USE_MAINHAND", mainHand, player);
            return;
        }
        
        // 오프핸드 커스텀 방패 우클릭 시에도 경고 (완전 차단은 어려움)
        ItemStack offHand = player.getInventory().getItemInOffHand();
        if (offHand.getType() == Material.SHIELD && isBlockedItem(offHand)) {
            // 오프핸드는 취소해도 블로킹이 발생할 수 있음
            // EntityDamageByEntityEvent에서 최종 차단
            player.sendMessage("§c커스텀 방패는 방어에 사용할 수 없습니다.");
            logBlocked("SHIELD_USE_OFFHAND", offHand, player);
        }
    }

    // ========== 헬퍼 메서드 ==========
    
    /**
     * 차단 대상 아이템인지 확인
     * 
     * 1. CoreItemAuthenticator로 PDC 확인 (정확)
     * 2. CustomModelData 폴백 (v1.1 전까지)
     */
    private boolean isBlockedItem(ItemStack item) {
        if (item == null || item.getType().isAir()) {
            return false;
        }
        
        // 1. Tycoon CoreItem 확인 (PDC 기반, 정확)
        if (coreItemAuthenticator.isCoreItem(item)) {
            return true;
        }
        
        // 2. CustomModelData 폴백 (v1.1 전까지, 외부 플러그인 없음)
        ItemMeta meta = item.getItemMeta();
        return meta != null && meta.hasCustomModelData();
    }
    
    /**
     * 차단 로깅
     */
    private void logBlocked(String eventType, ItemStack item, Player player) {
        if (!logBlocked) return;
        
        String itemInfo = item != null ? item.getType().name() : "null";
        String playerInfo = player != null ? player.getName() : "N/A";
        
        logger.info("[CustomItemVanillaBlocker] 차단: " + eventType + 
                   " - 아이템=" + itemInfo + ", 플레이어=" + playerInfo);
    }

    // ========== 공개 API ==========
    
    public boolean isEnabled() {
        return enabled;
    }
    
    public void setEnabled(boolean enabled) {
        this.enabled = enabled;
        logger.info("[CustomItemVanillaBlocker] enabled=" + enabled);
    }
}
