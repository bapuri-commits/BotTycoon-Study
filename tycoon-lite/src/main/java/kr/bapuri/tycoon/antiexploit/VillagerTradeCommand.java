package kr.bapuri.tycoon.antiexploit;

import kr.bapuri.tycoon.player.PlayerDataManager;
import org.bukkit.Bukkit;
import org.bukkit.command.Command;
import org.bukkit.command.CommandExecutor;
import org.bukkit.command.CommandSender;
import org.bukkit.command.TabCompleter;
import org.bukkit.entity.Player;

import java.util.ArrayList;
import java.util.Arrays;
import java.util.List;
import java.util.UUID;

/**
 * VillagerTradeCommand - 주민 거래 관리 명령어
 * 
 * /villagertrade info <player>     - 거래 횟수 조회
 * /villagertrade reset <player|@a> - 거래 횟수 리셋
 * /villagertrade toggle            - 시스템 ON/OFF 토글
 * 
 * 권한: tycoon.admin.villagertrade
 */
public class VillagerTradeCommand implements CommandExecutor, TabCompleter {

    private final VillagerTradeBlocker blocker;
    private final PlayerDataManager playerDataManager;

    public VillagerTradeCommand(VillagerTradeBlocker blocker, PlayerDataManager playerDataManager) {
        this.blocker = blocker;
        this.playerDataManager = playerDataManager;
    }

    @Override
    public boolean onCommand(CommandSender sender, Command command, String label, String[] args) {
        if (!sender.hasPermission("tycoon.admin.villagertrade")) {
            sender.sendMessage("§c권한이 없습니다.");
            return true;
        }

        if (args.length == 0) {
            showUsage(sender);
            return true;
        }

        String subCmd = args[0].toLowerCase();

        switch (subCmd) {
            case "info" -> handleInfo(sender, args);
            case "reset" -> handleReset(sender, args);
            case "toggle" -> handleToggle(sender);
            default -> showUsage(sender);
        }

        return true;
    }

    /**
     * /villagertrade info <player>
     */
    private void handleInfo(CommandSender sender, String[] args) {
        if (args.length < 2) {
            sender.sendMessage("§c사용법: /villagertrade info <player>");
            return;
        }

        Player target = Bukkit.getPlayerExact(args[1]);
        if (target == null) {
            sender.sendMessage("§c온라인 플레이어를 찾을 수 없습니다: " + args[1]);
            return;
        }

        int tradeCount = blocker.getTradeCount(target);
        int freeLimit = blocker.getFreeTradeLimit();
        int remaining = blocker.getRemainingFreeTrades(target);
        long nextCost = blocker.getNextTradeCost(target);

        sender.sendMessage("§e=== " + target.getName() + " 주민 거래 정보 ===");
        sender.sendMessage("§7총 거래 횟수: §f" + tradeCount);
        sender.sendMessage("§7무료 한도: §f" + freeLimit);
        sender.sendMessage("§7남은 무료 거래: §f" + remaining);
        if (remaining == 0) {
            sender.sendMessage("§7다음 거래 비용: §f" + String.format("%,d", nextCost) + " BD");
        }
    }

    /**
     * /villagertrade reset <player|@a>
     */
    private void handleReset(CommandSender sender, String[] args) {
        if (args.length < 2) {
            sender.sendMessage("§c사용법: /villagertrade reset <player|@a>");
            return;
        }

        String targetArg = args[1];

        if (targetArg.equalsIgnoreCase("@a")) {
            // 전체 온라인 플레이어 리셋
            int count = 0;
            for (Player online : Bukkit.getOnlinePlayers()) {
                blocker.resetTradeCount(online);
                count++;
            }
            sender.sendMessage("§a" + count + "명의 주민 거래 횟수를 리셋했습니다.");
        } else {
            // 특정 플레이어 리셋
            Player target = Bukkit.getPlayerExact(targetArg);
            if (target == null) {
                // 오프라인 플레이어 처리 시도
                @SuppressWarnings("deprecation")
                org.bukkit.OfflinePlayer offline = Bukkit.getOfflinePlayer(targetArg);
                if (offline.hasPlayedBefore()) {
                    UUID uuid = offline.getUniqueId();
                    playerDataManager.get(uuid).setVillagerTradeCount(0);
                    sender.sendMessage("§a" + targetArg + "의 주민 거래 횟수를 리셋했습니다. (오프라인)");
                } else {
                    sender.sendMessage("§c플레이어를 찾을 수 없습니다: " + targetArg);
                }
                return;
            }

            blocker.resetTradeCount(target);
            sender.sendMessage("§a" + target.getName() + "의 주민 거래 횟수를 리셋했습니다.");
        }
    }

    /**
     * /villagertrade toggle
     */
    private void handleToggle(CommandSender sender) {
        boolean newState = !blocker.isEnabled();
        blocker.setEnabled(newState);
        
        if (newState) {
            sender.sendMessage("§a주민 거래 제한 시스템이 §e활성화§a되었습니다.");
        } else {
            sender.sendMessage("§c주민 거래 제한 시스템이 §7비활성화§c되었습니다.");
        }
    }

    private void showUsage(CommandSender sender) {
        sender.sendMessage("§e=== 주민 거래 관리 명령어 ===");
        sender.sendMessage("§7/villagertrade info <player> §8- 거래 횟수 조회");
        sender.sendMessage("§7/villagertrade reset <player|@a> §8- 거래 횟수 리셋");
        sender.sendMessage("§7/villagertrade toggle §8- 시스템 ON/OFF 토글");
        sender.sendMessage("§7현재 상태: " + (blocker.isEnabled() ? "§a활성화" : "§c비활성화"));
    }

    @Override
    public List<String> onTabComplete(CommandSender sender, Command command, String alias, String[] args) {
        if (!sender.hasPermission("tycoon.admin.villagertrade")) {
            return List.of();
        }

        List<String> completions = new ArrayList<>();

        if (args.length == 1) {
            List<String> subCommands = Arrays.asList("info", "reset", "toggle");
            String partial = args[0].toLowerCase();
            for (String sub : subCommands) {
                if (sub.startsWith(partial)) {
                    completions.add(sub);
                }
            }
        } else if (args.length == 2) {
            String subCmd = args[0].toLowerCase();
            if (subCmd.equals("info") || subCmd.equals("reset")) {
                String partial = args[1].toLowerCase();
                
                // @a 옵션 (reset만)
                if (subCmd.equals("reset") && "@a".startsWith(partial)) {
                    completions.add("@a");
                }
                
                // 온라인 플레이어
                for (Player p : Bukkit.getOnlinePlayers()) {
                    if (p.getName().toLowerCase().startsWith(partial)) {
                        completions.add(p.getName());
                    }
                }
            }
        }

        return completions;
    }
}
