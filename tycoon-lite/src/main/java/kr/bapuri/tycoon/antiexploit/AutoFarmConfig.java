package kr.bapuri.tycoon.antiexploit;

import org.bukkit.Material;
import org.bukkit.configuration.ConfigurationSection;
import org.bukkit.configuration.file.FileConfiguration;
import org.bukkit.configuration.file.YamlConfiguration;
import org.bukkit.plugin.java.JavaPlugin;

import java.io.File;
import java.io.InputStream;
import java.io.InputStreamReader;
import java.nio.charset.StandardCharsets;
import java.util.*;
import java.util.logging.Logger;

/**
 * AutoFarmConfig - 자동화 팜 제한 설정
 * 
 * autofarm.yml에서 모든 설정을 로드
 */
public class AutoFarmConfig {

    private final JavaPlugin plugin;
    private final Logger logger;
    private FileConfiguration config;
    private File configFile;

    // ===== 설정값 =====
    private boolean enabled;
    private int perChunkPerHour;
    private int resetPeriodHours;
    
    // 점진적 감소
    private boolean reductionEnabled;
    private TreeMap<Integer, Double> reductionThresholds;  // percent -> multiplier
    
    // 제한 대상 아이템
    private Set<Material> limitedMaterials;
    
    // 메시지
    private Map<String, String> messages;
    
    private boolean debug;

    public AutoFarmConfig(JavaPlugin plugin) {
        this.plugin = plugin;
        this.logger = plugin.getLogger();
        this.reductionThresholds = new TreeMap<>();
        this.limitedMaterials = EnumSet.noneOf(Material.class);
        this.messages = new HashMap<>();
    }

    /**
     * 설정 로드
     */
    public void load() {
        saveDefaultConfig();
        configFile = new File(plugin.getDataFolder(), "autofarm.yml");
        config = YamlConfiguration.loadConfiguration(configFile);

        // 기본값 병합
        InputStream defaultStream = plugin.getResource("autofarm.yml");
        if (defaultStream != null) {
            YamlConfiguration defaultConfig = YamlConfiguration.loadConfiguration(
                    new InputStreamReader(defaultStream, StandardCharsets.UTF_8));
            config.setDefaults(defaultConfig);
        }

        loadSettings();
        loadReduction();
        loadMaterials();
        loadMessages();

        if (debug) {
            logger.info("[AutoFarmConfig] 설정 로드 완료 (enabled=" + enabled + 
                       ", perChunkPerHour=" + perChunkPerHour + 
                       ", materials=" + limitedMaterials.size() + ")");
        }
    }

    private void saveDefaultConfig() {
        File file = new File(plugin.getDataFolder(), "autofarm.yml");
        if (!file.exists()) {
            plugin.saveResource("autofarm.yml", false);
        }
    }

    public void reload() {
        load();
    }

    // ===== 설정 로드 =====

    private void loadSettings() {
        enabled = config.getBoolean("enabled", true);
        perChunkPerHour = config.getInt("limits.per-chunk-per-hour", 1000);
        resetPeriodHours = config.getInt("reset-period-hours", 1);
        debug = config.getBoolean("debug", false);
    }

    private void loadReduction() {
        reductionEnabled = config.getBoolean("reduction.enabled", false);
        reductionThresholds.clear();

        ConfigurationSection thresholds = config.getConfigurationSection("reduction.thresholds");
        if (thresholds != null) {
            for (String key : thresholds.getKeys(false)) {
                try {
                    int percent = Integer.parseInt(key);
                    double multiplier = thresholds.getDouble(key, 1.0);
                    reductionThresholds.put(percent, multiplier);
                } catch (NumberFormatException e) {
                    logger.warning("[AutoFarmConfig] 잘못된 threshold 키: " + key);
                }
            }
        }

        // 기본값
        if (reductionThresholds.isEmpty()) {
            reductionThresholds.put(80, 0.7);
            reductionThresholds.put(90, 0.5);
            reductionThresholds.put(100, 0.1);
        }
    }

    private void loadMaterials() {
        limitedMaterials.clear();
        List<String> materialNames = config.getStringList("limited-materials");

        for (String name : materialNames) {
            try {
                Material material = Material.valueOf(name.toUpperCase());
                limitedMaterials.add(material);
            } catch (IllegalArgumentException e) {
                logger.warning("[AutoFarmConfig] 알 수 없는 Material: " + name);
            }
        }

        // 기본값
        if (limitedMaterials.isEmpty()) {
            limitedMaterials.add(Material.SUGAR_CANE);
            limitedMaterials.add(Material.PUMPKIN);
            limitedMaterials.add(Material.MELON_SLICE);
            limitedMaterials.add(Material.CACTUS);
            limitedMaterials.add(Material.BAMBOO);
            limitedMaterials.add(Material.KELP);
        }
    }

    private void loadMessages() {
        messages.clear();
        ConfigurationSection msgSection = config.getConfigurationSection("messages");
        if (msgSection != null) {
            for (String key : msgSection.getKeys(false)) {
                String value = msgSection.getString(key, "");
                messages.put(key, value.replace('&', '§'));
            }
        }
    }

    // ===== Getter =====

    public boolean isEnabled() {
        return enabled;
    }

    public int getPerChunkPerHour() {
        return perChunkPerHour;
    }

    public int getResetPeriodHours() {
        return resetPeriodHours;
    }

    public long getResetPeriodMillis() {
        return (long) resetPeriodHours * 60 * 60 * 1000;
    }

    public boolean isReductionEnabled() {
        return reductionEnabled;
    }

    public boolean isLimitedMaterial(Material material) {
        return limitedMaterials.contains(material);
    }

    public Set<Material> getLimitedMaterials() {
        return Collections.unmodifiableSet(limitedMaterials);
    }

    public boolean isDebug() {
        return debug;
    }

    /**
     * 상한 비율에 따른 드롭 배율 계산
     * 
     * @param percent 현재 상한 비율 (0-100+)
     * @return 드롭 배율 (1.0 = 100%, 0.5 = 50%)
     */
    public double getDropMultiplier(int percent) {
        if (!reductionEnabled || percent < 80) {
            return 1.0;
        }

        // TreeMap에서 현재 percent 이하의 가장 가까운 threshold 찾기
        Map.Entry<Integer, Double> entry = reductionThresholds.floorEntry(percent);
        if (entry != null) {
            return entry.getValue();
        }

        return 1.0;
    }

    /**
     * 마을 청크 수에 따른 시간당 상한 계산
     */
    public int calculateLandLimit(int chunkCount) {
        return chunkCount * perChunkPerHour;
    }

    // ===== 메시지 =====

    public String getMessage(String key) {
        return messages.getOrDefault(key, "§c[AutoFarm] 메시지 없음: " + key);
    }

    public String getMessage(String key, Map<String, String> placeholders) {
        String msg = getMessage(key);
        for (Map.Entry<String, String> entry : placeholders.entrySet()) {
            msg = msg.replace("{" + entry.getKey() + "}", entry.getValue());
        }
        return msg;
    }
}
