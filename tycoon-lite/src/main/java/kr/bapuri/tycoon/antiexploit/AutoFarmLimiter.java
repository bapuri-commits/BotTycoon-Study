package kr.bapuri.tycoon.antiexploit;

import kr.bapuri.tycoon.integration.LandsIntegration;
import org.bukkit.Location;
import org.bukkit.Material;
import org.bukkit.entity.Item;
import org.bukkit.entity.Player;
import org.bukkit.event.EventHandler;
import org.bukkit.event.EventPriority;
import org.bukkit.event.Listener;
import org.bukkit.event.block.BlockDropItemEvent;
import org.bukkit.inventory.ItemStack;
import org.bukkit.plugin.java.JavaPlugin;

import java.util.*;
import java.util.logging.Logger;

/**
 * AutoFarmLimiter - 자동화 팜 드롭 제한 리스너
 * 
 * 기능:
 * - 마을 내 자동화 팜 생산량 추적
 * - 상한 도달 시 점진적 드롭 감소
 * - 야생에서는 제한 없음
 * 
 * 우선순위: HIGHEST (등급 보너스 적용 후)
 */
public class AutoFarmLimiter implements Listener {

    private final JavaPlugin plugin;
    private final Logger logger;
    private final AutoFarmConfig config;
    private final AutoFarmTracker tracker;
    private final LandsIntegration landsIntegration;

    public AutoFarmLimiter(JavaPlugin plugin, AutoFarmConfig config, 
                          AutoFarmTracker tracker, LandsIntegration landsIntegration) {
        this.plugin = plugin;
        this.logger = plugin.getLogger();
        this.config = config;
        this.tracker = tracker;
        this.landsIntegration = landsIntegration;
    }

    /**
     * 블록 드롭 아이템 이벤트 처리
     * 
     * HIGHEST 우선순위로 등급 보너스(HIGH) 적용 후 실행
     */
    @EventHandler(priority = EventPriority.HIGHEST, ignoreCancelled = true)
    public void onBlockDropItem(BlockDropItemEvent event) {
        if (!config.isEnabled()) {
            return;
        }

        Player player = event.getPlayer();
        Location location = event.getBlock().getLocation();

        // 관리자 바이패스
        if (player.hasPermission("tycoon.autofarm.bypass")) {
            return;
        }

        // 마을 영역 확인
        Optional<LandsIntegration.PlotInfo> plotOpt = landsIntegration.getPlotAt(location);
        if (plotOpt.isEmpty()) {
            // 야생에서는 제한 없음
            return;
        }

        String landName = plotOpt.get().getName();
        
        // 제한 대상 아이템 필터링 및 총량 계산
        int totalLimitedAmount = 0;
        List<Item> limitedItems = new ArrayList<>();

        for (Item item : event.getItems()) {
            Material type = item.getItemStack().getType();
            if (config.isLimitedMaterial(type)) {
                totalLimitedAmount += item.getItemStack().getAmount();
                limitedItems.add(item);
            }
        }

        if (totalLimitedAmount == 0) {
            return; // 제한 대상 아이템 없음
        }

        // 생산량 추가 전 현재 상태 확인
        int beforeProduction = tracker.getProduction(landName);
        int limit = tracker.getLimit(landName);
        
        // 생산량 추가
        tracker.addProduction(landName, totalLimitedAmount);
        
        // 상한 비율 계산
        int percent = tracker.getPercent(landName);
        
        // 경고 메시지
        sendWarningIfNeeded(player, landName, percent, limit);

        // 점진적 감소 적용
        if (config.isReductionEnabled() && percent >= 80) {
            double multiplier = config.getDropMultiplier(percent);
            applyReduction(limitedItems, multiplier);
            
            if (config.isDebug()) {
                logger.info("[AutoFarmLimiter] " + player.getName() + " @ " + landName + 
                           " - " + percent + "% → " + (int)(multiplier * 100) + "% 드롭");
            }
        }
    }

    /**
     * 드롭 아이템에 감소 배율 적용
     * 
     * 확률적 감소: 소량 드롭(1개)도 배율에 따라 확률적으로 감소
     * 예: 1개 × 0.1 배율 = 10% 확률로 1개, 90% 확률로 0개
     */
    private void applyReduction(List<Item> items, double multiplier) {
        Iterator<Item> iterator = items.iterator();
        
        while (iterator.hasNext()) {
            Item item = iterator.next();
            ItemStack stack = item.getItemStack();
            
            int originalAmount = stack.getAmount();
            
            // 확률적 감소 계산
            double expected = originalAmount * multiplier;
            int base = (int) expected;
            double fraction = expected - base;
            
            // 소수점 부분은 확률로 처리
            if (Math.random() < fraction) {
                base++;
            }
            
            int reducedAmount = base;
            
            if (reducedAmount <= 0) {
                // 아이템 제거 (0개)
                item.remove();
            } else if (reducedAmount != originalAmount) {
                // 수량 감소
                stack.setAmount(reducedAmount);
            }
        }
    }

    /**
     * 경고 메시지 전송
     */
    private void sendWarningIfNeeded(Player player, String landName, int percent, int limit) {
        if (!tracker.shouldSendWarning(player.getUniqueId(), percent)) {
            return;
        }

        int production = tracker.getProduction(landName);
        Map<String, String> placeholders = new HashMap<>();
        placeholders.put("current", String.format("%,d", production));
        placeholders.put("limit", String.format("%,d", limit));
        placeholders.put("percent", String.valueOf(percent));
        placeholders.put("land", landName);

        String messageKey;
        if (percent >= 100) {
            messageKey = "warning-100";
        } else if (percent >= 90) {
            messageKey = "warning-90";
        } else if (percent >= 80) {
            messageKey = "warning-80";
        } else {
            return;
        }

        player.sendMessage(config.getMessage(messageKey, placeholders));
    }

    /**
     * 현재 상태 조회 (명령어용)
     */
    public String getStatus(String landName) {
        int production = tracker.getProduction(landName);
        int limit = tracker.getLimit(landName);
        int percent = tracker.getPercent(landName);
        double multiplier = tracker.getDropMultiplier(landName);

        return String.format(
            "§e[자동화 팜] %s 마을 상태\n" +
            "§7생산량: §f%,d§7/§f%,d §7(§e%d%%§7)\n" +
            "§7드롭 배율: §f%.0f%%",
            landName, production, limit, percent, multiplier * 100
        );
    }
}
