package kr.bapuri.tycoon.antiexploit;

import kr.bapuri.tycoon.job.farmer.CropGrade;
import kr.bapuri.tycoon.job.fisher.FishRarity;
import org.bukkit.Material;
import org.bukkit.event.EventHandler;
import org.bukkit.event.EventPriority;
import org.bukkit.event.Listener;
import org.bukkit.event.inventory.FurnaceSmeltEvent;
import org.bukkit.inventory.ItemStack;
import org.bukkit.plugin.Plugin;

import java.util.EnumMap;
import java.util.Map;
import java.util.logging.Logger;

/**
 * ItemTransformListener - 아이템 가공 시 속성 전달
 * 
 * 화로/훈연기에서 아이템을 구울 때 원본의 커스텀 속성을 결과물에 전달합니다.
 * 
 * 전달 대상:
 * - FishRarity (물고기 희귀도): COD → COOKED_COD, SALMON → COOKED_SALMON
 * - CropGrade (작물 등급): POTATO → BAKED_POTATO, KELP → DRIED_KELP, CHORUS_FRUIT → POPPED_CHORUS_FRUIT
 * 
 * @since 2026-02-02
 */
public class ItemTransformListener implements Listener {
    
    private final Plugin plugin;
    private final Logger logger;
    private final boolean debug;
    
    // 굽기 매핑: 원재료 → 결과물
    private static final Map<Material, Material> SMELT_MAPPING = new EnumMap<>(Material.class);
    
    static {
        // 물고기 (FishRarity 전달)
        SMELT_MAPPING.put(Material.COD, Material.COOKED_COD);
        SMELT_MAPPING.put(Material.SALMON, Material.COOKED_SALMON);
        
        // 작물 (CropGrade 전달)
        SMELT_MAPPING.put(Material.POTATO, Material.BAKED_POTATO);
        SMELT_MAPPING.put(Material.KELP, Material.DRIED_KELP);
        SMELT_MAPPING.put(Material.CHORUS_FRUIT, Material.POPPED_CHORUS_FRUIT);
    }
    
    public ItemTransformListener(Plugin plugin) {
        this.plugin = plugin;
        this.logger = plugin.getLogger();
        this.debug = plugin.getConfig().getBoolean("debug.itemTransform", false);
    }
    
    /**
     * 화로/훈연기 굽기 완료 시 속성 전달
     * 
     * HIGHEST 우선순위: 다른 플러그인보다 먼저 처리
     */
    @EventHandler(priority = EventPriority.HIGHEST, ignoreCancelled = true)
    public void onFurnaceSmelt(FurnaceSmeltEvent event) {
        ItemStack source = event.getSource();
        ItemStack result = event.getResult();
        
        if (source == null || result == null) {
            return;
        }
        
        Material sourceMaterial = source.getType();
        Material resultMaterial = result.getType();
        
        // 매핑 확인
        Material expectedResult = SMELT_MAPPING.get(sourceMaterial);
        if (expectedResult == null || expectedResult != resultMaterial) {
            return;
        }
        
        boolean transferred = false;
        
        // 1. FishRarity 전달 (물고기)
        if (FishRarity.isFishMaterial(sourceMaterial)) {
            FishRarity rarity = FishRarity.getRarity(source);
            if (rarity != FishRarity.COMMON) {
                FishRarity.applyRarity(result, rarity);
                transferred = true;
                
                if (debug) {
                    logger.info(String.format("[ItemTransform] FishRarity 전달: %s(%s) → %s",
                            sourceMaterial.name(), rarity.name(), resultMaterial.name()));
                }
            }
        }
        
        // 2. CropGrade 전달 (작물)
        if (CropGrade.isGradeableCrop(sourceMaterial)) {
            CropGrade grade = CropGrade.getGrade(source);
            if (grade != CropGrade.NORMAL) {
                CropGrade.applyGrade(result, grade);
                transferred = true;
                
                if (debug) {
                    logger.info(String.format("[ItemTransform] CropGrade 전달: %s(%s) → %s",
                            sourceMaterial.name(), grade.name(), resultMaterial.name()));
                }
            }
        }
        
        // 결과물 업데이트
        if (transferred) {
            event.setResult(result);
        }
    }
}
