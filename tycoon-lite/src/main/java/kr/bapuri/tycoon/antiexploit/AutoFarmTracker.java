package kr.bapuri.tycoon.antiexploit;

import kr.bapuri.tycoon.integration.LandsIntegration;
import org.bukkit.Bukkit;
import org.bukkit.plugin.java.JavaPlugin;
import org.bukkit.scheduler.BukkitTask;

import java.util.Map;
import java.util.UUID;
import java.util.concurrent.ConcurrentHashMap;
import java.util.logging.Logger;

/**
 * AutoFarmTracker - 플레이어/마을별 자동화 팜 생산량 추적
 * 
 * 기능:
 * - 마을별 시간당 생산량 추적
 * - 주기적 리셋
 * - 상한 도달 여부 확인
 */
public class AutoFarmTracker {

    private final JavaPlugin plugin;
    private final Logger logger;
    private final AutoFarmConfig config;
    private final LandsIntegration landsIntegration;

    // 마을 이름 → 시간당 생산량
    private final Map<String, LandProductionData> landProduction;
    
    // 플레이어 UUID → 마지막 경고 시간 (스팸 방지)
    private final Map<UUID, Long> lastWarningTime;
    
    private BukkitTask resetTask;

    public AutoFarmTracker(JavaPlugin plugin, AutoFarmConfig config, LandsIntegration landsIntegration) {
        this.plugin = plugin;
        this.logger = plugin.getLogger();
        this.config = config;
        this.landsIntegration = landsIntegration;
        this.landProduction = new ConcurrentHashMap<>();
        this.lastWarningTime = new ConcurrentHashMap<>();
    }

    /**
     * 추적 시작 (리셋 스케줄러)
     */
    public void start() {
        stop();

        long periodMillis = config.getResetPeriodMillis();
        long periodTicks = periodMillis / 50;

        // 리셋 주기마다 카운터 초기화
        resetTask = Bukkit.getScheduler().runTaskTimer(plugin, this::resetAll, periodTicks, periodTicks);

        logger.info("[AutoFarmTracker] 시작됨 (리셋 주기: " + config.getResetPeriodHours() + "시간)");
    }

    /**
     * 추적 중지
     */
    public void stop() {
        if (resetTask != null && !resetTask.isCancelled()) {
            resetTask.cancel();
            resetTask = null;
        }
    }

    /**
     * 생산량 추가
     * 
     * @param landName 마을 이름
     * @param amount 생산량
     * @return 추가 후 현재 생산량
     */
    public int addProduction(String landName, int amount) {
        String key = landName.toLowerCase();
        LandProductionData data = landProduction.computeIfAbsent(key, 
            k -> new LandProductionData());
        
        data.addProduction(amount);
        return data.getProduction();
    }

    /**
     * 현재 생산량 조회
     */
    public int getProduction(String landName) {
        String key = landName.toLowerCase();
        LandProductionData data = landProduction.get(key);
        return data != null ? data.getProduction() : 0;
    }

    /**
     * 마을의 상한 조회
     */
    public int getLimit(String landName) {
        var landOpt = landsIntegration.getLandByName(landName);
        if (landOpt.isEmpty()) {
            return config.getPerChunkPerHour(); // 기본값 (1청크)
        }
        
        int chunks = (int) landOpt.get().getSize();
        return config.calculateLandLimit(chunks);
    }

    /**
     * 상한 비율 계산 (0-100+)
     */
    public int getPercent(String landName) {
        int production = getProduction(landName);
        int limit = getLimit(landName);
        
        if (limit <= 0) {
            return 0;
        }
        
        return (int) ((production * 100.0) / limit);
    }

    /**
     * 드롭 배율 계산
     */
    public double getDropMultiplier(String landName) {
        int percent = getPercent(landName);
        return config.getDropMultiplier(percent);
    }

    /**
     * 경고 메시지 전송 (스팸 방지)
     */
    public boolean shouldSendWarning(UUID playerId, int percent) {
        // 80%, 90%, 100% 경계에서만 경고
        if (percent != 80 && percent != 90 && percent < 100) {
            return false;
        }
        
        long now = System.currentTimeMillis();
        Long lastTime = lastWarningTime.get(playerId);
        
        // 30초 쿨다운
        if (lastTime != null && now - lastTime < 30000) {
            return false;
        }
        
        lastWarningTime.put(playerId, now);
        return true;
    }

    /**
     * 모든 카운터 리셋
     */
    public void resetAll() {
        int count = landProduction.size();
        landProduction.clear();
        lastWarningTime.clear();
        
        if (config.isDebug()) {
            logger.info("[AutoFarmTracker] " + count + "개 마을 생산량 리셋됨");
        }
    }

    /**
     * 특정 마을 카운터 리셋
     */
    public void reset(String landName) {
        landProduction.remove(landName.toLowerCase());
    }

    /**
     * 디버그 정보
     */
    public String getDebugInfo(String landName) {
        int production = getProduction(landName);
        int limit = getLimit(landName);
        int percent = getPercent(landName);
        double multiplier = getDropMultiplier(landName);
        
        return String.format("Land: %s, Production: %d/%d (%d%%), Multiplier: %.1f",
            landName, production, limit, percent, multiplier);
    }

    // ===== 내부 클래스 =====

    /**
     * 마을 생산량 데이터
     */
    private static class LandProductionData {
        private int production = 0;

        public void addProduction(int amount) {
            this.production += amount;
        }

        public int getProduction() {
            return production;
        }
    }
}
